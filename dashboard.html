<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
    }
    .work-card {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .preview-img, .preview-pdf {
      max-width: 100%;
      height: auto;
      margin-top: 10px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    h2 {
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Welcome to Student Dashboard</h2><h3>Send Work</h3>
<select id="receiverIndex">
  <option value="">-- Select Receiver Index --</option>
  <option value="60056kn">60056kn</option>
  <option value="90052am">90052am</option>
  <option value="30043dv">30043dv</option>
</select><br><br>
<textarea id="workMessage" placeholder="Write your message..."></textarea><br><br>
<input type="file" id="workFile" /><br><br>
<button onclick="sendwork()">Send Work</button>

<h3>All Works</h3>
<div id="workList"></div>

<h3>Your Sent Works</h3>
<div id="sentList"></div>

  </div>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4Lk0EjPJAYPPKdzTBb-IOMP7kpzEmrFA",
      authDomain: "studentdashboard-final.firebaseapp.com",
      projectId: "studentdashboard-final",
      storageBucket: "studentdashboard-final.firebasestorage.app",
      messagingSenderId: "576065271267",
      appId: "1:576065271267:web:05636f4ae4236f3298dcd6",
      measurementId: "G-PQXQE19D1F"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    emailjs.init("rai8QxGoPo_kArORG"); // EmailJS public key

    async function sendwork() {
      const senderIndex = localStorage.getItem("index");
      const receiverIndex = document.getElementById("receiverIndex").value;
      const message = document.getElementById("workMessage").value;
      const fileInput = document.getElementById("workFile");

      if (!receiverIndex || !message || !fileInput.files[0]) {
        alert("Please fill all fields and select a file.");
        return;
      }

      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append("file", file);

      const uploadRes = await fetch("https://uploadthing.com/api/upload", {
        method: "POST",
        headers: {
          "Authorization": "Bearer eyJhcGlLZXkiOiJza19saXZlXzU2YzIxNmNmOTc3OTE4YzRmZGE2NDM4ZTAzNDVlNTI0NWNiMDNiN2UyMzg5OGZmYjY4Yjc0OTkyYzFjZGJhN2UiLCJhcHBJZCI6Im43d3VvMmRjbDgiLCJyZWdpb25zIjpbInNlYTEiXX0="
        },
        body: formData
      });

      const uploadData = await uploadRes.json();
      const fileUrl = uploadData.url || uploadData.data.url;

      await db.collection("works").add({
        senderIndex,
        receiverIndex,
        message,
        fileUrl,
        timestamp: Date.now()
      });

      emailjs.send("service_m6b648v", "template_iahgvur", {
        to_email: "kunalvats7988@gmail.com",
        from_index: senderIndex,
        to_index: receiverIndex,
        message: message,
        time: new Date().toLocaleString()
      });

      alert("Work sent successfully!");
      document.getElementById("workMessage").value = "";
      fileInput.value = "";
      DisplayEntries();
      loadSent();
    }

    async function DisplayEntries() {
      const container = document.getElementById("workList");
      container.innerHTML = "";
      const currentUser = localStorage.getItem("index");
      const querySnapshot = await db.collection("works").orderBy("timestamp", "desc").get();
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const id = doc.id;
        const card = document.createElement("div");
        card.className = "work-card";
        const isImage = /\.(jpg|jpeg|png|gif)$/i.test(data.fileUrl);
        const isPDF = /\.pdf$/i.test(data.fileUrl);
        let preview = isImage ? `<img src="${data.fileUrl}" class="preview-img" />` :
                       isPDF ? `<embed src="${data.fileUrl}" class="preview-pdf" type="application/pdf" />` :
                       `<a href="${data.fileUrl}" target="_blank">Download</a>`;
        card.innerHTML = `
          <h4><b>From:</b> ${data.senderIndex} âžœ <b>To:</b> ${data.receiverIndex}</h4>
          <p><b>Message:</b> ${data.message}</p>
          <p><b>Date:</b> ${new Date(data.timestamp).toLocaleString()}</p>
          ${preview}
          ${data.senderIndex === currentUser ? `<button onclick="deleteWork('${id}')">Delete</button>` : ""}
        `;
        container.appendChild(card);
      });
    }

    async function loadSent() {
      const container = document.getElementById("sentList");
      container.innerHTML = "";
      const currentUser = localStorage.getItem("index");
      const querySnapshot = await db.collection("works").where("senderIndex", "==", currentUser).orderBy("timestamp", "desc").get();
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const id = doc.id;
        const card = document.createElement("div");
        card.className = "work-card";
        const isImage = /\.(jpg|jpeg|png|gif)$/i.test(data.fileUrl);
        const isPDF = /\.pdf$/i.test(data.fileUrl);
        let preview = isImage ? `<img src="${data.fileUrl}" class="preview-img" />` :
                       isPDF ? `<embed src="${data.fileUrl}" class="preview-pdf" type="application/pdf" />` :
                       `<a href="${data.fileUrl}" target="_blank">Download</a>`;
        card.innerHTML = `
          <h4><b>To:</b> ${data.receiverIndex}</h4>
          <p><b>Message:</b> ${data.message}</p>
          <p><b>Time:</b> ${new Date(data.timestamp).toLocaleString()}</p>
          ${preview}
          <button onclick="deleteWork('${id}')">Delete</button>
        `;
        container.appendChild(card);
      });
    }

    async function deleteWork(id) {
      if (confirm("Are you sure you want to delete this work?")) {
        await db.collection("works").doc(id).delete();
        DisplayEntries();
        loadSent();
      }
    }

    window.onload = () => {
      DisplayEntries();
      loadSent();
    }
  </script></body>
</html>