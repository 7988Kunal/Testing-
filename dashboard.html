<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #eef2f7; padding: 20px; }
    .profile, .work-upload, .work-list { background: white; padding: 20px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; }
    input, textarea, button { width: 100%; padding: 10px; margin: 10px 0; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="https://uploadthing.com/widgets/widgets.umd.js"></script>
</head>
<body>
  <div class="profile">
    <h2>Profile</h2>
    <img id="photo" src="" />
    <p><strong>Name:</strong> <span id="name"></span></p>
    <p><strong>Class:</strong> <span id="class"></span></p>
    <p><strong>Branch:</strong> <span id="branch"></span></p>
    <uploadthing-widget
      id="editPhoto"
      ut-token="eyJhcGlLZXkiOiJza19saXZlXzU2YzIxNmNmOTc3OTE4YzRmZGE2NDM4ZTAzNDVlNTI0NWNiMDNiN2UyMzg5OGZmYjY4Yjc0OTkyYzFjZGJhN2UiLCJhcHBJZCI6Im43d3VvMmRjbDgiLCJyZWdpb25zIjpbInNlYTEiXX0="
      type="image"
    ></uploadthing-widget>
  </div>  <div class="work-upload">
    <h2>Upload Work</h2>
    <textarea id="message" placeholder="Enter your work message"></textarea>
    <uploadthing-widget
      id="uploadFile"
      ut-token="eyJhcGlLZXkiOiJza19saXZlXzU2YzIxNmNmOTc3OTE4YzRmZGE2NDM4ZTAzNDVlNTI0NWNiMDNiN2UyMzg5OGZmYjY4Yjc0OTkyYzFjZGJhN2UiLCJhcHBJZCI6Im43d3VvMmRjbDgiLCJyZWdpb25zIjpbInNlYTEiXX0="
    ></uploadthing-widget>
    <button onclick="uploadWork()">Upload Work</button>
  </div>  <div class="work-list">
    <h2>All Works</h2>
    <div id="workContainer"></div>
  </div>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4Lk0EjPJAYPPKdzTBb-IOMP7kpzEmrFA",
      authDomain: "studentdashboard-final.firebaseapp.com",
      projectId: "studentdashboard-final",
      storageBucket: "studentdashboard-final.firebasestorage.app",
      messagingSenderId: "576065271267",
      appId: "1:576065271267:web:05636f4ae4236f3298dcd6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    emailjs.init("rai8QxGoPo_kArORG");

    const index = localStorage.getItem("index");
    let uploadedFile = "";

    window.uploadthing.onUploadComplete((res) => {
      if (res && res.length > 0) uploadedFile = res[0].url;
    });

    async function loadProfile() {
      const doc = await db.collection('students').doc(index).get();
      if (!doc.exists) return;
      const data = doc.data();
      document.getElementById("photo").src = data.photo;
      document.getElementById("name").innerText = data.name;
      document.getElementById("class").innerText = data.class;
      document.getElementById("branch").innerText = data.branch;
    }

    async function uploadWork() {
      const message = document.getElementById("message").value.trim();
      if (!message || !uploadedFile) return alert("Message and file required");
      const time = new Date().toLocaleString();
      await db.collection("works").add({ index, message, file: uploadedFile, time });
      emailjs.send("service_m6b648v", "template_iahgvur", {
        to_email: "kunalvats7988@gmail.com",
        from_index: index,
        time,
        message
      });
      alert("Work uploaded");
      displayWorks();
    }

    async function displayWorks() {
      const snap = await db.collection("works").orderBy("time", "desc").get();
      const container = document.getElementById("workContainer");
      container.innerHTML = "";
      snap.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.innerHTML = `<p><b>${data.index}</b>: ${data.message} <br><a href='${data.file}' target='_blank'>View File</a> <br><small>${data.time}</small></p><hr>`;
        container.appendChild(div);
      });
    }

    loadProfile();
    displayWorks();

    window.uploadthing.onUploadComplete((res) => {
      if (!res || res.length === 0) alert("Upload failed: No file returned");
    });
  </script></body>
</html>