<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef2f7;
      padding: 20px;
    }

    form {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #ccc;
    }

    label {
      font-weight: bold;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin: 8px 0 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    #photoPreview {
      display: block;
      margin: 10px auto;
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid #aaa;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>

<script>
  if (localStorage.getItem("studentIndex") && localStorage.getItem("registered") === "true") {
    window.location.href = "dashboard.html";
  }
</script>

<h2 style="text-align:center;">Student Registration</h2>

<form id="registrationForm">
  <label>Full Name</label>
  <input type="text" id="fullName" required>

  <label>Index Number</label>
  <input type="text" id="indexNumber" required>

  <label>Class</label>
  <select id="class" required>
    <option value="">Select</option>
    <option value="B.Tech">B.Tech</option>
    <option value="B.E.">B.E.</option>
  </select>

  <label>Branch</label>
  <input type="text" id="branch" placeholder="e.g. Artificial Intelligence and Machine Learning" required>

  <label>Upload Photo</label>
  <input type="file" id="photoInput" accept="image/*" required>
  <img id="photoPreview" src="" alt="Photo Preview" />

  <button type="submit">Register</button>
</form>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD4Lk0EjPJAYPPKdzTBb-IOMP7kpzEmrFA",
    authDomain: "studentdashboard-final.firebaseapp.com",
    projectId: "studentdashboard-final",
    storageBucket: "studentdashboard-final.firebasestorage.app",
    messagingSenderId: "576065271267",
    appId: "1:576065271267:web:05636f4ae4236f3298dcd6",
    measurementId: "G-PQXQE19D1F"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>
  let uploadedPhotoURL = "";

  document.getElementById("photoInput").addEventListener("change", async function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch("https://uploadthing.com/api/upload", {
        method: "POST",
        headers: {
          "X-Uploadthing-Api-Key": "sk_live_56c216cf977918c4fda6438e0345e5245cb03b7e23898ffb68b74992c1cdba7e",
        },
        body: formData
      });

      const data = await res.json();
      if (data?.url) {
        uploadedPhotoURL = data.url;
        document.getElementById("photoPreview").src = uploadedPhotoURL;
      } else {
        alert("Upload failed: " + (data.error || "Unknown error"));
      }
    } catch (err) {
      alert("Photo upload error: " + err.message);
    }
  });

  document.getElementById("registrationForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const fullName = document.getElementById("fullName").value.trim();
    const indexNumber = document.getElementById("indexNumber").value.trim();
    const className = document.getElementById("class").value;
    const branch = document.getElementById("branch").value.trim();

    if (!uploadedPhotoURL) {
      alert("Please upload a photo.");
      return;
    }

    try {
      const docRef = db.collection("indexAccess").doc(indexNumber);
      const docSnap = await docRef.get();
      if (!docSnap.exists) {
        alert("This index is not authorized. Please contact admin.");
        return;
      }

      await db.collection("students").doc(indexNumber).set({
        fullName,
        className,
        branch,
        photoURL: uploadedPhotoURL,
        indexNumber
      });

      localStorage.setItem("studentIndex", indexNumber);
      localStorage.setItem("registered", "true");

      window.location.href = "dashboard.html";
    } catch (err) {
      alert("Registration failed: " + err.message);
    }
  });
</script>

</body>
</html>
